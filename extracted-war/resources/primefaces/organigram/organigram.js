PrimeFaces.widget.Organigram=PrimeFaces.widget.BaseWidget.extend({init:function(a){this._super(a);this.draw()},draw:function(){this.source=this.jq.children("ul");this.target=this.jq.children("div");this.target.empty();this.drawNode(this.source.find("li:first").data("rowkey"),this.source.find("li:first"),this.target,0,0);this.setupSelection();this.setupDragAndDrop();this.setupControls()},setupSelection:function(){var b=this;var a=this.target.find(".ui-organigram-node.selectable");a.on("click",function(){b.selectNode(b,$(this),"select")});if(this.cfg.autoScrollToSelection===true){this.scrollToSelection()}},selectNode:function(d,c,b){if(!c.hasClass("selected")){d.target.find(".ui-organigram-node.selected").removeClass("selected");c.addClass("selected");if(d.hasBehavior(b)){var a={params:[{name:d.id+"_selectNode",value:c.data("rowkey")}]};d.cfg.behaviors[b].call(d,a)}}},setupDragAndDrop:function(){var c=this;var a=this.target.find(".ui-organigram-node");var d=a.filter(".draggable");var b=a.filter(".droppable");var e={x:0,y:0};d.draggable({zIndex:100,opacity:0.7,cursor:"move",helper:"clone",distance:60,revert:"invalid",revertDuration:200,snapMode:"inner",start:function(f){e.x=f.clientX;e.y=f.clientY},drag:function(h,i){var f=i.originalPosition;var g=1;if(c.zoomFactor){g=c.zoomFactor}i.position={left:(h.clientX-e.x+f.left)/g,top:(h.clientY-e.y+f.top)/g}}});b.droppable({accept:".ui-organigram-node.draggable",activeClass:"drag-active",hoverClass:"drop-hover"});b.bind("drop",function(f,l){var o=$(this).data("rowkey");var j=c.source.find("li").filter(function(){return $(this).data("rowkey")===o});var g=j.children("ul");var n=l.draggable.data("rowkey");var i=c.source.find("li").filter(function(){return $(this).data("rowkey")===n});var h=i.parent("ul");var k=false;if(i.data("parent-rowkey")===o){k=true}if(j.data("parent-rowkey")===n){k=true}j.parents().each(function(){if($(this).data("parent-rowkey")===n){k=true;return false}});if(k){return false}if(g.length>0){g.append(i)}else{j.append("<ul></ul>");j.children("ul").append(i)}if(h.children().length===0){h.remove()}var m=c.source.find("li").filter(function(){return $(this).data("rowkey")===i.data("parent-rowkey")});if(m.children("ul").length===0){m.addClass("leaf")}j.removeClass("leaf");i.data("parent-rowkey",o);i.attr("data-parent-rowkey",o);if(c.hasBehavior("dragdrop")){var p={params:[{name:c.id+"_dragNode",value:n},{name:c.id+"_dropNode",value:o}]};c.cfg.behaviors.dragdrop.call(c,p)}c.redraw=true});d.bind("dragstop",function(f,g){if(c.redraw){c.draw();c.redraw=false}})},setupControls:function(){var d=this;if(this.cfg.zoom){this.jq.children(".controls").remove();var b=$("<div class='controls'></div>").appendTo(this.jq);var c=$("<table></table>").appendTo(b);if(!this.zoomFactor){this.zoomFactor=1}else{this.zoom(this.zoomFactor)}var e=$("<tr><td><div class='control zoom-in' title='Zoom In'>&nbsp;</div></td></tr>").appendTo(c);e.on("click",function(){d.zoomFactor+=0.1;d.zoom(d.zoomFactor)});var a=$("<tr><td><div class='control zoom-out' title='Zoom Out'>&nbsp;</div></td></tr>").appendTo(c);a.on("click",function(){d.zoomFactor-=0.1;d.zoom(d.zoomFactor)})}},zoom:function(b){var a=this.target.find(">:first-child");if(PrimeFaces.env.isIE()){a.css("zoom",b)}else{a.css("-moz-transform","scale("+b+")");a.css("-moz-transform-origin","0 0");a.css("-o-transform","scale("+b+")");a.css("-o-transform-origin","0 0");a.css("-webkit-transform","scale("+b+")");a.css("-webkit-transform-origin","0 0");a.css("transform","scale("+b+")");a.css("transform-origin","0 0")}},drawNode:function(b,l,f,c){var e=l.children("ul:first").children("li");var j=e.length===0;var i=l.clone().children("ul,li").remove().end().html();var o=$("<div>");o.attr("class",l.attr("class"));o.attr("style",l.attr("style"));o.addClass("ui-organigram-node");o.addClass("level-"+c);o.attr("data-level",c);o.attr("data-rowkey",l.data("rowkey"));o.attr("data-parent-rowkey",b);var n=$("<div class='ui-organigram-icon-container'></div>").appendTo(o);if(l.data("icon")){var t=$("<div class='ui-organigram-icon ui-icon'></div>").appendTo(n);t.addClass(l.data("icon"));var g=l.data("icon-pos");if(g&&(g==="left"||g==="right")){t.addClass(l.data("icon-pos"))}}o.append(i);var m=$("<div class='ui-organigram-icon-container'></div>").appendTo(o);if(j){f.append(o)}else{if(e.length>0){var s=$("<table cellpadding='0' cellspacing='0' border='0'/>").appendTo(f);var h=$("<tr/>").appendTo(s);var a=e.filter(".leaf:not(.skip-leaf)");var p=e.filter(":not(.leaf),.skip-leaf");var q=p.length;if(a&&a.length>0){q+=1}var d=$("<td colspan='"+(q*2)+"'/>").appendTo(h);d.append(o);this.addExpander(l,o,m);this.drawLines(q,s);this.drawChildNodes(l.data("rowkey"),a,p,s,c);if(l.hasClass("collapsed")){var r="ui-icon-plusthick";if(l.data("collapsed-icon")){r=l.data("collapsed-icon")}var k="ui-icon-minusthick";if(l.data("expanded-icon")){k=l.data("expanded-icon")}h.nextAll("tr").hide();o.find(".expander").removeClass(k).addClass(r)}else{if(!l.hasClass("expanded")){o.addClass("expanded")}}}}},addExpander:function(c,e,d){if(e.hasClass("collapsible")){var b=c.data("collapsed-icon")?c.data("collapsed-icon"):"ui-icon-plusthick";var a=c.data("expanded-icon")?c.data("expanded-icon"):"ui-icon-minusthick";var g=e.hasClass("collapsed")?b:a;var f=this;var h=$("<div class='expander ui-icon "+g+"'>&nbsp;</div>").appendTo(d);h.click(function(k){var m=$(this);var j=m.closest(".ui-organigram-node");var l=j.closest("tr");if(j.hasClass("collapsed")){j.removeClass("collapsed").addClass("expanded");m.removeClass(b).addClass(a);l.nextAll("tr").show();c.removeClass("collapsed");if(f.hasBehavior("expand")){var i={params:[{name:f.id+"_expandNode",value:j.data("rowkey")}]};f.cfg.behaviors.expand.call(f,i)}}else{j.removeClass("expanded").addClass("collapsed");m.removeClass(a).addClass(b);l.nextAll("tr").hide();c.addClass("collapsed");if(f.hasBehavior("collapse")){var i={params:[{name:f.id+"_collapseNode",value:j.data("rowkey")}]};f.cfg.behaviors.collapse.call(f,i)}}k.stopPropagation()})}},drawLines:function(g,d){var b=g*2;var a=$("<tr/>").appendTo(d);var e=$("<td colspan='"+b+"'/>").appendTo(a);e.append($("<div class='line down'></div>"));var f=$("<tr/>").appendTo(d);for(var c=0;c<g;c++){f.append($("<td class='line left top'></td>"));f.append($("<td class='line right top'></td>"))}f.find("td:first").removeClass("top");f.find("td:last").removeClass("top")},drawChildNodes:function(l,g,h,n,b){var o=$("<tr/>").appendTo(n);if(g&&g.length>0){var m=$("<td colspan='2'/>").appendTo(o);var c=$("<table cellpadding='0' cellspacing='0' border='0'/>").appendTo(m);for(var d=0;d<g.length;d++){if(d!==0&&this.cfg.leafNodeConnectorHeight>0){c.append($("<tr><td><div class='line down' style='height:"+this.cfg.leafNodeConnectorHeight+"px'></div></td></tr>"))}var k=$("<tr/>").appendTo(c);var f=$("<td/>").appendTo(k);var a=$(g[d]);this.drawNode(l,a,f,b+1)}}for(var e=0;e<h.length;e++){var m=$("<td colspan='2'/>").appendTo(o);var a=$(h[e]);this.drawNode(l,a,m,b+1)}},bindContextMenu:function(e,f,c,b){var a=c+" .ui-organigram-node.selectable",d=b.event+".organigram";if(b.nodeType){a+="."+b.nodeType}$(document).off(d,a).on(d,a,null,function(g){f.selectNode(f,$(this),"contextmenu");e.show(g)})},scrollToSelection:function(){var a=this.target.find(".ui-organigram-node.selected");if(a.length>0){var b=a.offset();this.target.animate({scrollTop:b.top,scrollLeft:b.left},{easing:"easeInCirc"},1000)}}});